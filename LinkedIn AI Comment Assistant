// ==UserScript==
// @name         LinkedIn AI Comment Assistant (via Google AI) - v1.2
// @namespace    http://tampermonkey.net/
// @version      1.2
// @description  Adds a button to generate thoughtful, personalized comments on LinkedIn posts using the Google AI API.
// @author       Kushan Perera
// @match        https://www.linkedin.com/feed/*
// @match        https://www.linkedin.com/posts/*
// @connect      generativelanguage.googleapis.com
// @grant        GM_xmlhttpRequest
// @grant        GM_setValue
// @grant        GM_getValue
// ==/UserScript==

(function() {
    'use strict';

    // --- Configuration ---
    const GOOGLE_AI_API_KEY_STORAGE = 'googleAiApiKey';

    // --- SELECTORS ---
    const POST_SELECTOR = "div[data-urn*=':activity:']";
    // *** THIS IS THE LINE WE UPDATED BASED ON YOUR HTML ***
    const ACTION_BAR_SELECTOR = ".feed-shared-social-action-bar";
    const COMMENT_BOX_SELECTOR = ".ql-editor p";
    const AUTHOR_NAME_SELECTOR = ".update-components-actor__name .app-aware-link";
    const POST_TEXT_SELECTOR = ".update-components-text";
    // --- END OF SELECTORS ---

    async function getApiKey() {
        let apiKey = await GM_getValue(GOOGLE_AI_API_KEY_STORAGE, null);
        if (!apiKey) {
            apiKey = prompt('Please enter your Google AI Studio API key. You only need to do this once.');
            if (apiKey) {
                await GM_setValue(GOOGLE_AI_API_KEY_STORAGE, apiKey);
                alert('API Key saved! The page will now reload.');
                window.location.reload();
            }
        }
        return apiKey;
    }

    function generateComment(apiKey, postContent, authorName, button) {
         const promptText = `
            You are a professional networking assistant helping me comment on a LinkedIn post.
            My goal is to build my personal brand by being supportive, insightful, and encouraging discussion.

            Please generate a thoughtful, 2-3 sentence comment for the following LinkedIn post.
            - Acknowledge the author, "${authorName}", by name in a natural way.
            - Add a unique insight or relate it to a broader concept.
            - End with an open-ended question to spark a conversation.
            - Do NOT use generic phrases like "Great post" or "Thanks for sharing."
            - Do NOT include hashtags.

            Here is the post content:
            "${postContent}"
        `;

        GM_xmlhttpRequest({
            method: 'POST',
            url: `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`,
            headers: { 'Content-Type': 'application/json' },
            data: JSON.stringify({ "contents": [{ "parts": [{ "text": promptText }] }] }),
            onload: function(response) {
                try {
                    const result = JSON.parse(response.responseText);
                    const commentText = result.candidates[0].content.parts[0].text.trim();
                    const postContainer = button.closest(POST_SELECTOR);
                    const commentBox = postContainer.querySelector(COMMENT_BOX_SELECTOR);
                    if(commentBox) {
                        commentBox.textContent = commentText;
                    } else {
                       alert('Could not find the comment box to place the text.');
                    }
                    button.textContent = 'âœ¨ Generate AI Comment';
                    button.disabled = false;
                } catch (e) {
                    console.error('Error parsing AI response:', e, response.responseText);
                    alert('Could not understand the AI response. See the console (F12) for details.');
                    button.textContent = 'Error! Try Again';
                    button.disabled = false;
                }
            },
            onerror: function(response) {
                console.error('AI API Request Failed:', response);
                alert('Failed to connect to the Google AI API. Check your API key and network connection.');
                button.textContent = 'Error! Try Again';
                button.disabled = false;
            }
        });
    }

    function addAiButtonToPosts() {
        const posts = document.querySelectorAll(POST_SELECTOR);
        posts.forEach(post => {
            if (post.querySelector('.ai-comment-button')) return;

            const actionBar = post.querySelector(ACTION_BAR_SELECTOR);
            if (actionBar) {
                const aiButton = document.createElement('button');
                aiButton.innerHTML = 'âœ¨ AI Comment';
                aiButton.className = 'ai-comment-button';
                // Some styling to make it fit in
                aiButton.style.marginLeft = '10px';
                aiButton.style.padding = '8px 12px';
                aiButton.style.border = 'none';
                aiButton.style.borderRadius = '4px';
                aiButton.style.color = '#0a66c2';
                aiButton.style.backgroundColor = '#eef3f8';
                aiButton.style.cursor = 'pointer';
                aiButton.style.fontWeight = '600';
                aiButton.style.fontFamily = 'inherit';
                aiButton.style.fontSize = '14px';
                aiButton.style.display = 'inline-flex';
                aiButton.style.alignItems = 'center';

                aiButton.addEventListener('click', async (e) => {
                    e.preventDefault();
                    const apiKey = await getApiKey();
                    if (!apiKey) return;

                    aiButton.textContent = 'ðŸ§  Thinking...';
                    aiButton.disabled = true;

                    const authorElement = post.querySelector(AUTHOR_NAME_SELECTOR);
                    const postContentElement = post.querySelector(POST_TEXT_SELECTOR);
                    const authorName = authorElement ? authorElement.innerText.split('\n')[0].trim() : 'the author';
                    const postContent = postContentElement ? postContentElement.innerText : '';

                    if (!postContent) {
                        alert("Couldn't find the text of this post. It might be a video or image-only post.");
                        aiButton.innerHTML = 'âœ¨ AI Comment';
                        aiButton.disabled = false;
                        return;
                    }
                    generateComment(apiKey, postContent, authorName, aiButton);
                });

                actionBar.appendChild(aiButton);
            }
        });
    }

    // --- Main Execution ---
    getApiKey();
    const observer = new MutationObserver(addAiButtonToPosts);
    observer.observe(document.body, { childList: true, subtree: true });

})();
